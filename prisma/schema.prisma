datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RoleEnum {
  Maker
  Checker
}

enum DealType {
  buy
  sell
}

enum TransactionMode {
  cash
  credit
}

enum DealStatusEnum {
  Pending
  Completed
  Reject
  Approve
}

enum ReconciliationStatusEnum {
  Tallied
  Short
  Excess
}

enum SessionStatus {
  active
  inactive
  terminated
  timeout
}

model User {
  id                    Int       @id @default(autoincrement())
  full_name             String
  email                 String    @unique
  password              String
  phone_number          String
  role                  RoleEnum
  is_active             Boolean
  must_change_password  Boolean
  password_last_changed DateTime?
  deactivated_at        DateTime?
  deactivated_by        Int?
  deactivation_reason   String?
  deleted_by            Int?
  force_logout          Boolean   @default(false)
  last_login            DateTime?
  created_at            DateTime
  updated_at            DateTime
  deleted_at            DateTime?

  details               UserDetail?
  sessions              UserSession[]
  dealsCreated          Deal[]           @relation("DealCreatedBy")
  dealsActionBy         Deal[]           @relation("DealActionBy")
  dealDownloadedRecords Deal[]           @relation("DealDownloadedBy")
  reconciliations       Reconciliation[] @relation("ReconciliationCreatedBy")
}

model UserDetail {
  id                    Int       @id @default(autoincrement())
  user_id               Int       @unique
  password_expiry_date  DateTime?
  failed_login_attempts Int?
  last_failed_login     DateTime?
  reason                String?
  created_at            DateTime
  updated_at            DateTime

  user User @relation(fields: [user_id], references: [id])
}

model UserSession {
  id             Int           @id @default(autoincrement())
  user_id        Int
  token          String        @db.Text
  device_info    String?
  session_status SessionStatus @default(active)
  login_time     DateTime?
  logout_time    DateTime?
  last_activity  DateTime?
  created_at     DateTime
  updated_at     DateTime

  user User @relation(fields: [user_id], references: [id])
}

model Currency {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  name       String
  symbol     String
  created_at DateTime
  updated_at DateTime

  receivedDeals Deal[] @relation("ReceivedCurrency")
  paidDeals     Deal[] @relation("PaidCurrency")

  openingReconciliations Reconciliation[] @relation("OpeningCurrency")
  closingReconciliations Reconciliation[] @relation("ClosingCurrency")
}

model Deal {
  id                   Int             @id @default(autoincrement())
  deal_number          String          @unique
  customer_name        String
  deal_type            DealType
  transaction_mode     TransactionMode
  amount               Decimal
  rate                 Decimal
  received_price       String?
  received_quantity    String?
  received_currency_id Int
  paid_price           String?
  paid_quantity        String?
  paid_currency_id     Int
  remarks              String?
  action_reason        String?
  download_file_path   String?
  downloaded_by        Int?
  downloaded_at        DateTime?
  is_downloaded        Boolean         @default(false)
  status               DealStatusEnum
  created_by           Int
  action_by            Int?
  action_at            DateTime?
  created_at           DateTime
  updated_at           DateTime
  deleted_at           DateTime?

  receivedCurrency Currency   @relation("ReceivedCurrency", fields: [received_currency_id], references: [id])
  paidCurrency     Currency   @relation("PaidCurrency", fields: [paid_currency_id], references: [id])
  createdBy        User       @relation("DealCreatedBy", fields: [created_by], references: [id])
  actionBy         User?      @relation("DealActionBy", fields: [action_by], references: [id])
  downloadedBy     User?      @relation("DealDownloadedBy", fields: [downloaded_by], references: [id])
}

model Reconciliation {
  id                   Int                    @id @default(autoincrement())
  opening_denomination Int
  opening_quantity     Int
  opening_amount       Int
  opening_currency_id  Int
  closing_denomination Int
  closing_quantity     Int
  closing_amount       Int
  closing_currency_id  Int
  status               ReconciliationStatusEnum
  created_by           Int
  created_at           DateTime
  updated_at           DateTime

  openingCurrency Currency @relation("OpeningCurrency", fields: [opening_currency_id], references: [id])
  closingCurrency Currency @relation("ClosingCurrency", fields: [closing_currency_id], references: [id])
  createdBy       User     @relation("ReconciliationCreatedBy", fields: [created_by], references: [id])
}

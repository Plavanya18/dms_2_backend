datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum RoleEnum {
  Maker
  Checker
}

enum DealType {
  buy
  sell
}

enum TransactionMode {
  cash
  credit
}

enum DealStatusEnum {
  Pending
  Completed
}

enum ReconciliationStatusEnum {
  Tallied
  Short
  Excess
}

enum SessionStatus {
  active
  inactive
  terminated
  timeout
}

model User {
  id                    Int       @id @default(autoincrement())
  full_name             String
  email                 String    @unique
  password              String
  phone_number          String
  role                  RoleEnum
  is_active             Boolean
  must_change_password  Boolean
  password_last_changed DateTime?
  deactivated_at        DateTime?
  deactivated_by        Int?
  deactivation_reason   String?
  deleted_by            Int?
  force_logout          Boolean   @default(false)
  last_login            DateTime?
  created_at            DateTime
  updated_at            DateTime
  deleted_at            DateTime?

  details         UserDetail?
  sessions        UserSession[]
  dealsCreated    Deal[]           @relation("DealCreatedBy")
  dealsActionBy   Deal[]           @relation("DealActionBy")
  customers       Customer[]       @relation("CustomerCreatedBy")
  reconciliations Reconciliation[] @relation("ReconciliationCreatedBy")
}

model UserDetail {
  id                    Int       @id @default(autoincrement())
  user_id               Int       @unique
  password_expiry_date  DateTime?
  failed_login_attempts Int?
  last_failed_login     DateTime?
  reason                String?
  created_at            DateTime
  updated_at            DateTime

  user User @relation(fields: [user_id], references: [id])
}

model UserSession {
  id             Int           @id @default(autoincrement())
  user_id        Int
  token          String        @db.Text
  session_status SessionStatus
  login_time     DateTime?
  logout_time    DateTime?
  last_activity  DateTime?
  created_at     DateTime
  updated_at     DateTime

  user User @relation(fields: [user_id], references: [id])
}

model Currency {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  name       String
  symbol     String
  created_at DateTime
  updated_at DateTime

  receivedEntries        DealReceived[]
  paidEntries            DealPaid[]
  openingReconciliations ReconciliationOpening[]
  closingReconciliations ReconciliationClosing[]
}

model Customer {
  id           Int      @id @default(autoincrement())
  name         String
  phone_number String
  email        String?
  created_by   Int
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  createdBy User @relation("CustomerCreatedBy", fields: [created_by], references: [id])

  deals Deal[]
}

model Deal {
  id               Int             @id @default(autoincrement())
  deal_number      String          @unique
  customer_id      Int
  deal_type        DealType
  transaction_mode TransactionMode
  amount           Decimal
  rate             Decimal
  amount_to_be_paid  Decimal
  remarks          String?
  action_reason    String?
  status           DealStatusEnum
  created_by       Int
  action_by        Int?
  action_at        DateTime?
  created_at       DateTime
  updated_at       DateTime
  deleted_at       DateTime?

  customer Customer @relation(fields: [customer_id], references: [id])

  createdBy User  @relation("DealCreatedBy", fields: [created_by], references: [id])
  actionBy  User? @relation("DealActionBy", fields: [action_by], references: [id])

  received_items DealReceived[]
  paid_items     DealPaid[]

  reconciliations ReconciliationDeal[]
}

model DealReceived {
  id          Int    @id @default(autoincrement())
  deal_id     Int
  price       String
  quantity    String
  total       String
  currency_id Int

  deal     Deal     @relation(fields: [deal_id], references: [id])
  currency Currency @relation(fields: [currency_id], references: [id])
}

model DealPaid {
  id          Int    @id @default(autoincrement())
  deal_id     Int
  price       String
  quantity    String
  total       String
  currency_id Int

  deal     Deal     @relation(fields: [deal_id], references: [id])
  currency Currency @relation(fields: [currency_id], references: [id])
}

model Reconciliation {
  id         Int                      @id @default(autoincrement())
  status     ReconciliationStatusEnum
  created_by Int
  created_at DateTime
  updated_at DateTime

  createdBy User @relation("ReconciliationCreatedBy", fields: [created_by], references: [id])

  openingEntries ReconciliationOpening[]
  closingEntries ReconciliationClosing[]
  notes          ReconciliationNote[]
  deals          ReconciliationDeal[]
}

model ReconciliationOpening {
  id                Int @id @default(autoincrement())
  reconciliation_id Int
  denomination      Int
  quantity          Int
  amount            Int
  currency_id       Int

  reconciliation Reconciliation @relation(fields: [reconciliation_id], references: [id])
  currency       Currency       @relation(fields: [currency_id], references: [id])
}

model ReconciliationClosing {
  id                Int @id @default(autoincrement())
  reconciliation_id Int
  denomination      Int
  quantity          Int
  amount            Int
  currency_id       Int

  reconciliation Reconciliation @relation(fields: [reconciliation_id], references: [id])
  currency       Currency       @relation(fields: [currency_id], references: [id])
}

model ReconciliationNote {
  id                Int      @id @default(autoincrement())
  reconciliation_id Int
  note              String
  created_at        DateTime @default(now())

  reconciliation Reconciliation @relation(fields: [reconciliation_id], references: [id])
}

model ReconciliationDeal {
  id                Int @id @default(autoincrement())
  reconciliation_id Int
  deal_id           Int

  reconciliation Reconciliation @relation(fields: [reconciliation_id], references: [id])
  deal           Deal           @relation(fields: [deal_id], references: [id])
}
